.include "macro.inc"

# assembler directives
.set noat      # allow manual use of $at
.set noreorder # don't insert nops after branches
.set gp=64     # allow use of 64-bit general purpose registers

.section .text, "ax"

glabel __osViSwapContext
/* D31B0 800D25B0 27BDFFD8 */  addiu      $sp, $sp, -0x28
/* D31B4 800D25B4 AFB00010 */  sw         $s0, 0x10($sp)
/* D31B8 800D25B8 3C10800F */  lui        $s0, %hi(__osViNext)
/* D31BC 800D25BC 8E103D44 */  lw         $s0, %lo(__osViNext)($s0)
/* D31C0 800D25C0 3C02A440 */  lui        $v0, 0xa440
/* D31C4 800D25C4 34420010 */  ori        $v0, $v0, 0x10
/* D31C8 800D25C8 AFBF0024 */  sw         $ra, 0x24($sp)
/* D31CC 800D25CC AFB40020 */  sw         $s4, 0x20($sp)
/* D31D0 800D25D0 AFB3001C */  sw         $s3, 0x1c($sp)
/* D31D4 800D25D4 AFB20018 */  sw         $s2, 0x18($sp)
/* D31D8 800D25D8 AFB10014 */  sw         $s1, 0x14($sp)
/* D31DC 800D25DC 8C420000 */  lw         $v0, ($v0)
/* D31E0 800D25E0 8E040004 */  lw         $a0, 4($s0)
/* D31E4 800D25E4 8E120008 */  lw         $s2, 8($s0)
/* D31E8 800D25E8 0C034888 */  jal        osVirtualToPhysical
/* D31EC 800D25EC 30510001 */   andi      $s1, $v0, 1
/* D31F0 800D25F0 00111880 */  sll        $v1, $s1, 2
/* D31F4 800D25F4 00711821 */  addu       $v1, $v1, $s1
/* D31F8 800D25F8 00031880 */  sll        $v1, $v1, 2
/* D31FC 800D25FC 02431821 */  addu       $v1, $s2, $v1
/* D3200 800D2600 8C640028 */  lw         $a0, 0x28($v1)
/* D3204 800D2604 96030000 */  lhu        $v1, ($s0)
/* D3208 800D2608 30630002 */  andi       $v1, $v1, 2
/* D320C 800D260C 10600008 */  beqz       $v1, .L800D2630
/* D3210 800D2610 00443021 */   addu      $a2, $v0, $a0
/* D3214 800D2614 8E420020 */  lw         $v0, 0x20($s2)
/* D3218 800D2618 8E030020 */  lw         $v1, 0x20($s0)
/* D321C 800D261C 2404F000 */  addiu      $a0, $zero, -0x1000
/* D3220 800D2620 00441024 */  and        $v0, $v0, $a0
/* D3224 800D2624 00621825 */  or         $v1, $v1, $v0
/* D3228 800D2628 0803498E */  j          .L800D2638
/* D322C 800D262C AE030020 */   sw        $v1, 0x20($s0)
.L800D2630:
/* D3230 800D2630 8E420020 */  lw         $v0, 0x20($s2)
/* D3234 800D2634 AE020020 */  sw         $v0, 0x20($s0)
.L800D2638:
/* D3238 800D2638 96020000 */  lhu        $v0, ($s0)
/* D323C 800D263C 30420004 */  andi       $v0, $v0, 4
/* D3240 800D2640 1040002B */  beqz       $v0, .L800D26F0
/* D3244 800D2644 00111080 */   sll       $v0, $s1, 2
/* D3248 800D2648 00511021 */  addu       $v0, $v0, $s1
/* D324C 800D264C 00021080 */  sll        $v0, $v0, 2
/* D3250 800D2650 02421021 */  addu       $v0, $s2, $v0
/* D3254 800D2654 8C42002C */  lw         $v0, 0x2c($v0)
/* D3258 800D2658 30420FFF */  andi       $v0, $v0, 0xfff
/* D325C 800D265C 44822000 */  mtc1       $v0, $f4
/* D3260 800D2660 00000000 */  nop
/* D3264 800D2664 04410004 */  bgez       $v0, .L800D2678
/* D3268 800D2668 46802121 */   cvt.d.w   $f4, $f4
/* D326C 800D266C 3C01800E */  lui        $at, %hi(viswapcontext_rodata_0000)
/* D3270 800D2670 D42057B0 */  ldc1       $f0, %lo(viswapcontext_rodata_0000)($at)
/* D3274 800D2674 46202100 */  add.d      $f4, $f4, $f0
.L800D2678:
/* D3278 800D2678 C6020024 */  lwc1       $f2, 0x24($s0)
/* D327C 800D267C 46202020 */  cvt.s.d    $f0, $f4
/* D3280 800D2680 46001082 */  mul.s      $f2, $f2, $f0
/* D3284 800D2684 3C014F00 */  lui        $at, 0x4f00
/* D3288 800D2688 44810000 */  mtc1       $at, $f0
/* D328C 800D268C 00000000 */  nop
/* D3290 800D2690 4602003E */  c.le.s     $f0, $f2
/* D3294 800D2694 00000000 */  nop
/* D3298 800D2698 00000000 */  nop
/* D329C 800D269C 45030006 */  bc1tl      .L800D26B8
/* D32A0 800D26A0 46001001 */   sub.s     $f0, $f2, $f0
/* D32A4 800D26A4 4600100D */  trunc.w.s  $f0, $f2
/* D32A8 800D26A8 44040000 */  mfc1       $a0, $f0
/* D32AC 800D26AC 00000000 */  nop
/* D32B0 800D26B0 080349B3 */  j          .L800D26CC
/* D32B4 800D26B4 00111080 */   sll       $v0, $s1, 2
.L800D26B8:
/* D32B8 800D26B8 4600008D */  trunc.w.s  $f2, $f0
/* D32BC 800D26BC 44041000 */  mfc1       $a0, $f2
/* D32C0 800D26C0 3C028000 */  lui        $v0, 0x8000
/* D32C4 800D26C4 00822025 */  or         $a0, $a0, $v0
/* D32C8 800D26C8 00111080 */  sll        $v0, $s1, 2
.L800D26CC:
/* D32CC 800D26CC 00511021 */  addu       $v0, $v0, $s1
/* D32D0 800D26D0 00021080 */  sll        $v0, $v0, 2
/* D32D4 800D26D4 02421021 */  addu       $v0, $s2, $v0
/* D32D8 800D26D8 AE04002C */  sw         $a0, 0x2c($s0)
/* D32DC 800D26DC 8C42002C */  lw         $v0, 0x2c($v0)
/* D32E0 800D26E0 2403F000 */  addiu      $v1, $zero, -0x1000
/* D32E4 800D26E4 00431024 */  and        $v0, $v0, $v1
/* D32E8 800D26E8 080349C0 */  j          .L800D2700
/* D32EC 800D26EC 00821025 */   or        $v0, $a0, $v0
.L800D26F0:
/* D32F0 800D26F0 00511021 */  addu       $v0, $v0, $s1
/* D32F4 800D26F4 00021080 */  sll        $v0, $v0, 2
/* D32F8 800D26F8 02421021 */  addu       $v0, $s2, $v0
/* D32FC 800D26FC 8C42002C */  lw         $v0, 0x2c($v0)
.L800D2700:
/* D3300 800D2700 AE02002C */  sw         $v0, 0x2c($s0)
/* D3304 800D2704 8E53001C */  lw         $s3, 0x1c($s2)
/* D3308 800D2708 00111080 */  sll        $v0, $s1, 2
/* D330C 800D270C 00511021 */  addu       $v0, $v0, $s1
/* D3310 800D2710 00021080 */  sll        $v0, $v0, 2
/* D3314 800D2714 02428821 */  addu       $s1, $s2, $v0
/* D3318 800D2718 96040000 */  lhu        $a0, ($s0)
/* D331C 800D271C 3C05800F */  lui        $a1, %hi(vimgr_data_001C)
/* D3320 800D2720 8CA53D6C */  lw         $a1, %lo(vimgr_data_001C)($a1)
/* D3324 800D2724 8E230030 */  lw         $v1, 0x30($s1)
/* D3328 800D2728 30820020 */  andi       $v0, $a0, 0x20
/* D332C 800D272C 2C420001 */  sltiu      $v0, $v0, 1
/* D3330 800D2730 00021023 */  negu       $v0, $v0
/* D3334 800D2734 02629824 */  and        $s3, $s3, $v0
/* D3338 800D2738 00051400 */  sll        $v0, $a1, 0x10
/* D333C 800D273C 00621823 */  subu       $v1, $v1, $v0
/* D3340 800D2740 30840040 */  andi       $a0, $a0, 0x40
/* D3344 800D2744 10800005 */  beqz       $a0, .L800D275C
/* D3348 800D2748 0065A021 */   addu      $s4, $v1, $a1
/* D334C 800D274C 8E040004 */  lw         $a0, 4($s0)
/* D3350 800D2750 0C034888 */  jal        osVirtualToPhysical
/* D3354 800D2754 AE00002C */   sw        $zero, 0x2c($s0)
/* D3358 800D2758 00403021 */  addu       $a2, $v0, $zero
.L800D275C:
/* D335C 800D275C 96020000 */  lhu        $v0, ($s0)
/* D3360 800D2760 30420080 */  andi       $v0, $v0, 0x80
/* D3364 800D2764 10400008 */  beqz       $v0, .L800D2788
/* D3368 800D2768 3C0303FF */   lui       $v1, 0x3ff
/* D336C 800D276C 96020028 */  lhu        $v0, 0x28($s0)
/* D3370 800D2770 8E040004 */  lw         $a0, 4($s0)
/* D3374 800D2774 00021400 */  sll        $v0, $v0, 0x10
/* D3378 800D2778 00431024 */  and        $v0, $v0, $v1
/* D337C 800D277C 0C034888 */  jal        osVirtualToPhysical
/* D3380 800D2780 AE02002C */   sw        $v0, 0x2c($s0)
/* D3384 800D2784 00403021 */  addu       $a2, $v0, $zero
.L800D2788:
/* D3388 800D2788 3C02A440 */  lui        $v0, 0xa440
/* D338C 800D278C 34420004 */  ori        $v0, $v0, 4
/* D3390 800D2790 3C03A440 */  lui        $v1, 0xa440
/* D3394 800D2794 34630008 */  ori        $v1, $v1, 8
/* D3398 800D2798 3C04A440 */  lui        $a0, 0xa440
/* D339C 800D279C 34840014 */  ori        $a0, $a0, 0x14
/* D33A0 800D27A0 AC460000 */  sw         $a2, ($v0)
/* D33A4 800D27A4 8E420008 */  lw         $v0, 8($s2)
/* D33A8 800D27A8 3C05A440 */  lui        $a1, 0xa440
/* D33AC 800D27AC 34A50018 */  ori        $a1, $a1, 0x18
/* D33B0 800D27B0 AC620000 */  sw         $v0, ($v1)
/* D33B4 800D27B4 8E42000C */  lw         $v0, 0xc($s2)
/* D33B8 800D27B8 3C06A440 */  lui        $a2, 0xa440
/* D33BC 800D27BC 34C60020 */  ori        $a2, $a2, 0x20
/* D33C0 800D27C0 AC820000 */  sw         $v0, ($a0)
/* D33C4 800D27C4 8E420010 */  lw         $v0, 0x10($s2)
/* D33C8 800D27C8 3C03A440 */  lui        $v1, 0xa440
/* D33CC 800D27CC 3463001C */  ori        $v1, $v1, 0x1c
/* D33D0 800D27D0 ACA20000 */  sw         $v0, ($a1)
/* D33D4 800D27D4 8E420014 */  lw         $v0, 0x14($s2)
/* D33D8 800D27D8 3C04A440 */  lui        $a0, 0xa440
/* D33DC 800D27DC 34840024 */  ori        $a0, $a0, 0x24
/* D33E0 800D27E0 AC620000 */  sw         $v0, ($v1)
/* D33E4 800D27E4 8E420018 */  lw         $v0, 0x18($s2)
/* D33E8 800D27E8 3C03A440 */  lui        $v1, 0xa440
/* D33EC 800D27EC 34630028 */  ori        $v1, $v1, 0x28
/* D33F0 800D27F0 ACC20000 */  sw         $v0, ($a2)
/* D33F4 800D27F4 AC930000 */  sw         $s3, ($a0)
/* D33F8 800D27F8 AC740000 */  sw         $s4, ($v1)
/* D33FC 800D27FC 8E230034 */  lw         $v1, 0x34($s1)
/* D3400 800D2800 3C02A440 */  lui        $v0, 0xa440
/* D3404 800D2804 3442002C */  ori        $v0, $v0, 0x2c
/* D3408 800D2808 AC430000 */  sw         $v1, ($v0)
/* D340C 800D280C 8E230038 */  lw         $v1, 0x38($s1)
/* D3410 800D2810 3C02A440 */  lui        $v0, 0xa440
/* D3414 800D2814 3442000C */  ori        $v0, $v0, 0xc
/* D3418 800D2818 AC430000 */  sw         $v1, ($v0)
/* D341C 800D281C 8E030020 */  lw         $v1, 0x20($s0)
/* D3420 800D2820 3C02A440 */  lui        $v0, 0xa440
/* D3424 800D2824 34420030 */  ori        $v0, $v0, 0x30
/* D3428 800D2828 AC430000 */  sw         $v1, ($v0)
/* D342C 800D282C 8E03002C */  lw         $v1, 0x2c($s0)
/* D3430 800D2830 3C02A440 */  lui        $v0, 0xa440
/* D3434 800D2834 34420034 */  ori        $v0, $v0, 0x34
/* D3438 800D2838 AC430000 */  sw         $v1, ($v0)
/* D343C 800D283C 8E03000C */  lw         $v1, 0xc($s0)
/* D3440 800D2840 3C02800F */  lui        $v0, %hi(__osViCurr)
/* D3444 800D2844 8C423D40 */  lw         $v0, %lo(__osViCurr)($v0)
/* D3448 800D2848 02003021 */  addu       $a2, $s0, $zero
/* D344C 800D284C 24C80030 */  addiu      $t0, $a2, 0x30
/* D3450 800D2850 3C01800F */  lui        $at, %hi(__osViCurr)
/* D3454 800D2854 AC263D40 */  sw         $a2, %lo(__osViCurr)($at)
/* D3458 800D2858 00403821 */  addu       $a3, $v0, $zero
/* D345C 800D285C 3C02A440 */  lui        $v0, 0xa440
/* D3460 800D2860 3C01800F */  lui        $at, %hi(__osViNext)
/* D3464 800D2864 AC273D44 */  sw         $a3, %lo(__osViNext)($at)
/* D3468 800D2868 AC430000 */  sw         $v1, ($v0)
.L800D286C:
/* D346C 800D286C 8CC20000 */  lw         $v0, ($a2)
/* D3470 800D2870 8CC30004 */  lw         $v1, 4($a2)
/* D3474 800D2874 8CC40008 */  lw         $a0, 8($a2)
/* D3478 800D2878 8CC5000C */  lw         $a1, 0xc($a2)
/* D347C 800D287C ACE20000 */  sw         $v0, ($a3)
/* D3480 800D2880 ACE30004 */  sw         $v1, 4($a3)
/* D3484 800D2884 ACE40008 */  sw         $a0, 8($a3)
/* D3488 800D2888 ACE5000C */  sw         $a1, 0xc($a3)
/* D348C 800D288C 24C60010 */  addiu      $a2, $a2, 0x10
/* D3490 800D2890 14C8FFF6 */  bne        $a2, $t0, .L800D286C
/* D3494 800D2894 24E70010 */   addiu     $a3, $a3, 0x10
/* D3498 800D2898 8FBF0024 */  lw         $ra, 0x24($sp)
/* D349C 800D289C 8FB40020 */  lw         $s4, 0x20($sp)
/* D34A0 800D28A0 8FB3001C */  lw         $s3, 0x1c($sp)
/* D34A4 800D28A4 8FB20018 */  lw         $s2, 0x18($sp)
/* D34A8 800D28A8 8FB10014 */  lw         $s1, 0x14($sp)
/* D34AC 800D28AC 8FB00010 */  lw         $s0, 0x10($sp)
/* D34B0 800D28B0 03E00008 */  jr         $ra
/* D34B4 800D28B4 27BD0028 */   addiu     $sp, $sp, 0x28
/* D34B8 800D28B8 00000000 */  nop
/* D34BC 800D28BC 00000000 */  nop
